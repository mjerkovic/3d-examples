<html>
	<head>
		<script src="lib/three.min.js"></script>
		<script src="lib/controls.js"></script>
		<script src="lib/physi.js"></script>
		<script src="lib/physijs_worker.js"></script>
        <script src="scene.js"></script>
		<script>
		    var camera, scene, renderer, compass, controls, ball, clock, baseMesh;
            var rotationsPerSecond = Math.PI / 2.0; // * (Math.PI / 180);
            var target;

		   	function setup() {
			    init();
			    animate();
		   	}

		    function init() {
                clock = new THREE.Clock();
		    	Physijs.scripts.worker = 'lib/physijs_worker.js';
				Physijs.scripts.ammo = 'ammo.js';

		        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 500 );
		        camera.position.set(10, 2, 30);
    			camera.lookAt(new THREE.Vector3(0, 4, 0));

    			controls = new FirstPersonControls(camera);
    			controls.target = new THREE.Vector3(0, 4, 0);
    			controls.movementSpeed = 2;
    			controls.noFly = true;
    			controls.lookVertical = false;

                scene = initScene(camera);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize( window.innerWidth, window.innerHeight );
                renderer.setClearColor(0xDEDEDE);
                document.body.appendChild( renderer.domElement );
            }

            function animate() {
                var delta = clock.getDelta();
                controls.update(0.2);
                scene.simulate();
                /*var vectorToTarget = new THREE.Vector3().subVectors(target.position, baseMesh.position).normalize();
                var axis = new THREE.Vector3().crossVectors(vectorToTarget, ball.heading);
                var angle = -Math.acos(vectorToTarget.dot(ball.heading));
                ball.matrix.makeRotationAxis(axis, angle);
                ball.matrixAutoUpdate = false;
                ball.heading = vectorToTarget;*/
                //ball.rotation.y =  ball.position.angleTo(target.position);
                //ball.lookAt(target.position);

                //ball.rotation.y += rotationsPerSecond * delta;

                var vectorToTarget = new THREE.Vector3().subVectors(camera.position,
                        new THREE.Vector3().getPositionFromMatrix(ball.parent.matrix)).normalize();
                //var axis = new THREE.Vector3().crossVectors(vectorToTarget, ball.heading);
                //axis.normalize();
                var dot = vectorToTarget.dot(ball.heading);
                var angle = Math.acos(dot);
                //var m = new THREE.Matrix4().makeTranslation(0, 1, 0);
                //m.multiply(new THREE.Matrix4().makeRotationAxis(axis, angle));
                //ball.matrix = m; //.makeRotationAxis(axis, 0.1).multiply(m);
                //ball.matrixAutoUpdate = false;
                //ball.matrix.makeRotationAxis(new THREE.Vector3(0,1,0), angle);
                ball.rotation.y = vectorToTarget.x < 0 ? -angle : angle;
                //ball.updateMatrix();
                //ball.heading.applyMatrix4(m).normalize();

                scene.doIt();
		        renderer.render( scene, camera );
		        requestAnimationFrame( animate );
		    }
		</script>
	</head>
	<body onload="setup()">
	</body>		
</html>
